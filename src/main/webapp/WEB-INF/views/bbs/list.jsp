<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@include file="/WEB-INF/views/include/taglib.jsp" %>

<!DOCTYPE html>
<html lang="ko">
<head>
<%@include file="/WEB-INF/views/include/head.jsp" %>
<script>
$(document).ready(function() {
    $("#write-button").on("click", function() {
        document.bbsForm.action = "/bbs/write";
        document.bbsForm.submit();
    });

    $("#btnSearch").on("click", function() {
        document.bbsForm.searchType.value = $("#_searchType").val();
        document.bbsForm.searchValue.value = $("#_searchValue").val();
        document.bbsForm.periodFilter.value = $("#_periodFilter").val();
        document.bbsForm.bbsCurPage.value = "1";
        document.bbsForm.action = "/bbs/list<c:if test="${!empty cateNum}">?cateNum=${cateNum}</c:if>";
        document.bbsForm.submit();
    });

    $("#_searchType").on("change", function() {
        $("#_searchValue").val("");
        $("#_searchValue").focus();
    });

    <c:if test="${fn:length(cateNum) le 2}">
        $("#_cateFilter").on("change", function() {
            document.bbsForm.cateFilter.value = $("#_cateFilter").val();
            document.bbsForm.bbsCurPage.value = "1";
            document.bbsForm.action = "/bbs/list<c:if test="${!empty cateNum}">?cateNum=${cateNum}</c:if>";
            document.bbsForm.submit();
        });
    </c:if>

    $("#_bbsListCount").on("change", function() {
        document.bbsForm.bbsListCount.value = $("#_bbsListCount").val();
        document.bbsForm.bbsCurPage.value = "1";
        document.bbsForm.action = "/bbs/list<c:if test="${!empty cateNum}">?cateNum=${cateNum}</c:if>";
        document.bbsForm.submit();
    });

    $("#_bbsOrderBy").on("change", function() {
        document.bbsForm.bbsOrderBy.value = $("#_bbsOrderBy").val();
        document.bbsForm.bbsCurPage.value = "1";
        document.bbsForm.action = "/bbs/list<c:if test="${!empty cateNum}">?cateNum=${cateNum}</c:if>";
        document.bbsForm.submit();
    });

    $("#_isSecret").on("change", function() {
        document.bbsForm.isSecret.value = $("#_isSecret").val();
        document.bbsForm.bbsCurPage.value = "1";
        document.bbsForm.action = "/bbs/list<c:if test="${!empty cateNum}">?cateNum=${cateNum}</c:if>";
        document.bbsForm.submit();
    });
    
    $("#checkPasswordButton").on("click", function() {
        var inputPwd = $("#inputPassword").val();
        var bbsPwd = $("#passwordModal").data("bbsPwd");
        var bbsSeq = $("#passwordModal").data("bbsSeq");

        if (inputPwd === bbsPwd) {
            fn_view(bbsSeq);
            
        } else {
            alert("ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÌãÄÎ†∏ÏäµÎãàÎã§.");
        }
    });
});

function fn_view(bbsSeq) {
    document.bbsForm.bbsSeq.value = bbsSeq;
    document.bbsForm.action = "/bbs/view";
    document.bbsForm.submit();
}

function fn_list(bbsCurPage) {
    document.bbsForm.bbsCurPage.value = bbsCurPage;
    document.bbsForm.action = "/bbs/list";
    document.bbsForm.submit();
}

function openPasswordModal(bbsSeq, bbsPwd) {
    $("#passwordModal").data("bbsSeq", bbsSeq); 
    $("#passwordModal").data("bbsPwd", bbsPwd); 
    $("#passwordModal").show();
}

function closePasswordModal() {
    $("#passwordModal").hide();
    $("#inputPassword").val(""); 
}
</script>
</head>
<body id="index-body">
  <div class="Board-Main-Page">
    <div class="Board-Main">
      <%@include file="/WEB-INF/views/include/navigation.jsp"%>
      <div class="main-contanier">
        <%@include file="/WEB-INF/views/leftMainContent.jsp"%>
        <div class="right-main-content">
          <div class="right-main-content-header">
            <div class="right-main-content-header-title">
              <h1>
               <c:choose>
                <c:when test="${!empty cateNum}">
                  [${mainCateMap[fn:substring(cateNum, 0, 2)].mainCateName}]
                  <c:if test="${fn:length(cateNum) gt 2}">${subCateMap[cateNum].subCateName}</c:if>
                </c:when>
                <c:otherwise>
                  [Ï†ÑÏ≤¥ Í∏Ä]
                </c:otherwise>
               </c:choose>
              </h1>
            </div>
            <div class="right-main-content-header-search">
              <c:choose>
                <c:when test="${!empty cateNum}">
                  <c:if test="${fn:length(cateNum) le 2}">
                    <select class="cateFilter" id="_cateFilter" name="_cateFilter">
                      <option value="${cateNum}" style="font-weight: bold;">${mainCateMap[cateNum].mainCateName}</option>
                      <c:forEach var="subCate" items="${subCateListMap[cateNum]}" varStatus="status">
                        <option value="${subCate.subCateCombinedNum}" <c:if test="${cateFilter == subCate.subCateCombinedNum}">selected</c:if>>${subCate.subCateName}</option>
                      </c:forEach>
                    </select>
                  </c:if>
                </c:when>
                <c:otherwise>
                  <select class="cateFilter" id="_cateFilter" name="_cateFilter">
                   <option value="">Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù</option>
                   <c:forEach var="mainCate" items="${mainCateList}" varStatus="status">
                     <option value="${mainCate.mainCateNum}" style="font-weight: bold;" <c:if test="${cateFilter == mainCate.mainCateNum}">selected</c:if>>${mainCate.mainCateName}</option>
                     <c:forEach var="subCate" items="${subCateListMap[mainCate.mainCateNum]}" varStatus="status"> 
                       <option value="${subCate.subCateCombinedNum}" <c:if test="${cateFilter == subCate.subCateCombinedNum}">selected</c:if>>${subCate.subCateName}</option>
                     </c:forEach>
                   </c:forEach>
                  </select>
                </c:otherwise>
              </c:choose>
              <select class="bbsListCount" id="_bbsListCount" name="_bbsListCount">
                <option value="10" <c:if test="${bbsListCount == 10}">selected</c:if>>10Í∞ú</option>
                <option value="20" <c:if test="${bbsListCount == 20}">selected</c:if>>20Í∞ú</option>
                <option value="50" <c:if test="${bbsListCount == 50}">selected</c:if>>50Í∞ú</option>
              </select>
              <select class="bbsOrderBy" id="_bbsOrderBy" name="_bbsOrderBy">
                <option value="1" <c:if test="${bbsOrderBy == '1'}">selected</c:if>>Îì±Î°ùÏùº Ïàú</option>
                <option value="2" <c:if test="${bbsOrderBy == '2'}">selected</c:if>>Ï°∞ÌöåÏàò Ïàú</option>
                <option value="3" <c:if test="${bbsOrderBy == '3'}">selected</c:if>>Ï∂îÏ≤úÏàò Ïàú</option>
                <option value="4" <c:if test="${bbsOrderBy == '4'}">selected</c:if>>ÎåìÍ∏ÄÏàò Ïàú</option>
              </select>      
              <select class="isSecret" id="_isSecret" name="_isSecret">
                <option value="" <c:if test="${isSecret == ''}">selected</c:if>>Ï†ÑÏ≤¥ Î≥¥Í∏∞</option>
                <option value="Y" <c:if test="${isSecret == 'Y'}">selected</c:if>>üîí ÎπÑÎ∞ÄÍ∏ÄÎßå</option>
                <option value="N" <c:if test="${isSecret == 'N'}">selected</c:if>>üîì ÎπÑÎ∞ÄÍ∏Ä Ï†úÏô∏</option>
              </select>
            </div>
          </div>

          <table class="notice-board">
            <thead>
              <tr>
                <th scope="col" class="text-center" style="width: 8%">Î∂ÅÎßàÌÅ¨</th>
                <th scope="col" class="text-center" style="width: 5%">Î≤àÌò∏</th>
                <th scope="col" class="text-center" style="width: 21%">Ïπ¥ÌÖåÍ≥†Î¶¨</th>
                <th scope="col" class="text-center" style="width: 30%">Ï†úÎ™©</th>
                <th scope="col" class="text-center" style="width: 6%">ÏûëÏÑ±Ïûê</th>
                <th scope="col" class="text-center" style="width: 20%">ÏûëÏÑ±Ïùº</th>
                <th scope="col" class="text-center" style="width: 5%">Ï°∞Ìöå</th>
                <th scope="col" class="text-center" style="width: 5%">Ï∂îÏ≤ú</th>
              </tr>
            </thead>
            <tbody>
              <c:choose>
                <c:when test="${!empty bbsList}">
                  <c:forEach var="bbs" items="${bbsList}" varStatus="status">
                    <tr class="text-center-view" onclick="<c:choose><c:when test='${empty bbs.bbsPwd or loginUser.userType == "ADMIN" or loginUser.userId == bbs.userId}'>fn_view(${bbs.bbsSeq})</c:when><c:otherwise>openPasswordModal(${bbs.bbsSeq}, '${bbs.bbsPwd}')</c:otherwise></c:choose>">
                      <td class="text-center">
                        <c:choose>
                          <c:when test="${bbs.isBookmarked == 'Y' }"><i class="fa-solid fa-bookmark"></i></c:when>
                          <c:otherwise><i class="fa-regular fa-bookmark"></i></c:otherwise>
                        </c:choose>
                      </td>
                      <td class="text-center">${bbs.bbsSeq}</td>
                      <td class="text-center">${bbs.bbsSubCateName}</td>
                      <td class="text-center-title">
                        <c:choose>
                          <c:when test="${empty bbs.bbsPwd}">
                            <a href="javascript:void(0)"><c:out value="${bbs.bbsTitle}" /><c:if test="${bbs.bbsComCnt != 0}">(<fmt:formatNumber type="Number" maxFractionDigits="3" groupingUsed="true" value="${bbs.bbsComCnt}"/>)</c:if></a>
                          </c:when>
                          <c:otherwise>
                            <a href="javascript:void(0)">üîë ÎπÑÎ∞ÄÍ∏Ä ÏûÖÎãàÎã§.</a>                            
                          </c:otherwise>
                        </c:choose>
                      </td>
                      <td class="text-center">${bbs.userName}</td>
                      <td class="text-center">${bbs.bbsRegDate}</td>
                      <td class="text-center"><fmt:formatNumber type="Number" maxFractionDigits="3" groupingUsed="true" value="${bbs.bbsReadCnt}"/></td>
                      <td class="text-center"><fmt:formatNumber type="Number" maxFractionDigits="3" groupingUsed="true" value="${bbs.bbsRecomCnt}"/></td>
                    </tr>
                  </c:forEach>
                </c:when>
                <c:otherwise>
                  <tr>
                    <td colspan="8" class="text-center">Í≤åÏãúÍ∏ÄÏù¥ Ï°¥Ïû¨ÌïòÏßÄ ÏïäÏäµÎãàÎã§.</td>
                  </tr>
                </c:otherwise>
              </c:choose>
            </tbody>
          </table>
          
          <c:choose>
            <c:when test="${!empty cateNum}">
              <c:choose>
                <c:when test="${loginUser.userType == 'USER'}">
                  <c:if test="${!fn:startsWith(cateNum, '05') && !fn:startsWith(cateNum, '01')}">
                    <div class="write-button-container">
                      <a href="javascript:void(0)" class="write-button" id="write-button">Í∏ÄÏì∞Í∏∞</a>
                    </div>
                  </c:if>
                </c:when>
                <c:when test="${loginUser.userType == 'BLOGGER'}">
                  <c:if test="${!fn:startsWith(cateNum, '05') && !fn:startsWith(cateNum, '0101')}">
                    <div class="write-button-container">
                      <a href="javascript:void(0)" class="write-button" id="write-button">Í∏ÄÏì∞Í∏∞</a>
                    </div>
                  </c:if>            
                </c:when>
                <c:when test="${loginUser.userType == 'ADMIN'}">
                  <div class="write-button-container">
                    <a href="javascript:void(0)" class="write-button" id="write-button">Í∏ÄÏì∞Í∏∞</a>
                  </div>
                </c:when>
              </c:choose>
            </c:when>         
            <c:otherwise>
              <div class="write-button-container">
                <a href="javascript:void(0)" class="write-button" id="write-button">Í∏ÄÏì∞Í∏∞</a>
              </div>
            </c:otherwise>
          </c:choose>
          
          <!-- ÌéòÏù¥Ïßï Ï≤òÎ¶¨ -->
          <div class="pagination">
            <ul>
              <c:if test="${!empty bbsPaging}">
                <c:if test="${bbsPaging.prevBlockPage gt 0}">
                  <li><a href="javascript:void(0)" onclick="fn_list(${bbsPaging.prevBlockPage})">Ïù¥Ï†Ñ</a></li>
                </c:if>
                <c:forEach var="i" begin="${bbsPaging.startPage}" end="${bbsPaging.endPage}" step="1" varStatus="status">
                  <c:choose>
                    <c:when test="${i ne bbsPaging.curPage}">
                      <li><a href="javascript:void(0)" onclick="fn_list(${i})">${i}</a></li>
                    </c:when>
                    <c:otherwise>
                      <li><a href="javascript:void(0)" style="cursor:default; color: #999;">${i}</a></li>
                    </c:otherwise> 
                  </c:choose>                  
                </c:forEach>
                <c:if test="${bbsPaging.nextBlockPage gt 0}">
                  <li><a href="javascript:void(0)" onclick="fn_list(${bbsPaging.nextBlockPage})">Îã§Ïùå</a></li>
                </c:if>
              </c:if>
            </ul>
          </div>
          
          <!-- Í≤ÄÏÉâ Î∞î -->
          <div class="search-bar">
            <select name="_periodFilter" id="_periodFilter">
              <option value="">Ï†ÑÏ≤¥</option>
              <option value="1" <c:if test="${periodFilter == '1'}">selected</c:if>>7Ïùº Ï†Ñ</option>
              <option value="2" <c:if test="${periodFilter == '2'}">selected</c:if>>1Í∞úÏõî Ï†Ñ</option>
              <option value="3" <c:if test="${periodFilter == '3'}">selected</c:if>>3Í∞úÏõî Ï†Ñ</option>
              <option value="4" <c:if test="${periodFilter == '4'}">selected</c:if>>6Í∞úÏõî Ï†Ñ</option>
              <option value="5" <c:if test="${periodFilter == '5'}">selected</c:if>>1ÎÖÑ Ï†Ñ</option>
            </select>
            <select name="_searchType" id="_searchType">
              <option value="">Í≤ÄÏÉâ ÌÉÄÏûÖ</option>
              <option value="1" <c:if test="${searchType == '1'}">selected</c:if>>Ï†úÎ™©</option>
              <option value="2" <c:if test="${searchType == '2'}">selected</c:if>>Ï†úÎ™© + ÎÇ¥Ïö©</option>
              <option value="3" <c:if test="${searchType == '3'}">selected</c:if>>ÏûëÏÑ±Ïûê</option>
            </select> 
            <input type="text" name="_searchValue" id="_searchValue" value="${searchValue}" placeholder="Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
            <button type="button" id="btnSearch">Í≤ÄÏÉâ</button>
          </div>
          
        </div>
      </div>
      <%@ include file="/WEB-INF/views/include/footer.jsp"%>
    </div>
  </div>
  <div id="passwordModal" style="display:none;">
    <div class="modal-content">
      <span class="close" onclick="closePasswordModal()">&times;</span>
      <h3>ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûÖÎ†•</h3>
      <input type="password" id="inputPassword" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî" />
      <button id="checkPasswordButton">ÌôïÏù∏</button>
    </div>
  </div>
  <form name="bbsForm" id="bbsForm" method="post">
    <input type="hidden" name="bbsSeq" value="">
    <input type="hidden" name="bbsListCount" value="${bbsListCount}">
    <input type="hidden" name="bbsCurPage" value="${bbsCurPage}">
    <input type="hidden" name="cateNum" value="${cateNum}">
    <input type="hidden" name="cateFilter" value="${cateFilter}">
    <input type="hidden" name="periodFilter" value="${periodFilter}">
    <input type="hidden" name="bbsOrderBy" value="${bbsOrderBy}">  
    <input type="hidden" name="isSecret" value="${isSecret}">
    <input type="hidden" name="searchType" value="${searchType}">
    <input type="hidden" name="searchValue" value="${searchValue}">
  </form>
</body>
</html>